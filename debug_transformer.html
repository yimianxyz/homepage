<!DOCTYPE html>
<html>
<head>
    <title>Transformer Debug</title>
    <script src="src/config/constants.js"></script>
    <script src="src/config/model.js"></script>
    <script src="src/utils/vector.js"></script>
    <script src="src/ai/transformer_encoder.js"></script>
    <script src="src/ai/input_processor.js"></script>
    <script src="src/ai/action_processor.js"></script>
</head>
<body>
    <h1>Transformer Debug</h1>
    <div id="output"></div>
    
    <script>
        function debugTransformer() {
            const output = document.getElementById('output');
            
            try {
                // Create transformer components
                const transformer = new TransformerEncoder();
                const inputProcessor = new InputProcessor();
                const actionProcessor = new ActionProcessor();
                
                output.innerHTML += `<p>✅ Transformer initialized successfully</p>`;
                output.innerHTML += `<p>Model load result: ${transformer.modelLoadResult.success ? 'SUCCESS' : 'FAILED'}</p>`;
                if (!transformer.modelLoadResult.success) {
                    output.innerHTML += `<p>⚠️ Error: ${transformer.modelLoadResult.fallbackReason}</p>`;
                }
                
                // Create test data
                const testBoids = [
                    { position: {x: 100, y: 100}, velocity: {x: 1, y: 0} },
                    { position: {x: 200, y: 150}, velocity: {x: -1, y: 1} },
                    { position: {x: 300, y: 200}, velocity: {x: 0, y: -1} }
                ];
                
                const predatorPos = {x: 150, y: 150};
                const predatorVel = {x: 0.5, y: 0.5};
                const canvasWidth = 800;
                const canvasHeight = 600;
                
                // Process inputs
                const structuredInputs = inputProcessor.processInputs(
                    testBoids, predatorPos, predatorVel, canvasWidth, canvasHeight
                );
                
                output.innerHTML += `<p>✅ Input processing successful</p>`;
                output.innerHTML += `<p>Boid count: ${structuredInputs.boids.length}</p>`;
                output.innerHTML += `<p>Context: w=${structuredInputs.context.canvasWidth.toFixed(3)}, h=${structuredInputs.context.canvasHeight.toFixed(3)}</p>`;
                output.innerHTML += `<p>Predator vel: vx=${structuredInputs.predator.velX.toFixed(3)}, vy=${structuredInputs.predator.velY.toFixed(3)}</p>`;
                
                // Test transformer forward pass
                const neuralOutputs = transformer.forward(structuredInputs);
                
                output.innerHTML += `<p>✅ Transformer forward pass successful</p>`;
                output.innerHTML += `<p>Neural outputs: [${neuralOutputs[0].toFixed(4)}, ${neuralOutputs[1].toFixed(4)}]</p>`;
                
                // Check for NaN or invalid values
                if (isNaN(neuralOutputs[0]) || isNaN(neuralOutputs[1])) {
                    output.innerHTML += `<p>❌ ERROR: NaN values in neural outputs!</p>`;
                } else if (Math.abs(neuralOutputs[0]) < 1e-6 && Math.abs(neuralOutputs[1]) < 1e-6) {
                    output.innerHTML += `<p>⚠️ WARNING: Very small neural outputs (might be effectively zero)</p>`;
                } else {
                    output.innerHTML += `<p>✅ Neural outputs appear normal</p>`;
                }
                
                // Test action processing
                const actions = actionProcessor.processAction(neuralOutputs);
                
                output.innerHTML += `<p>✅ Action processing successful</p>`;
                output.innerHTML += `<p>Final actions: [${actions[0].toFixed(4)}, ${actions[1].toFixed(4)}]</p>`;
                
                // Check action magnitude
                const magnitude = Math.sqrt(actions[0] * actions[0] + actions[1] * actions[1]);
                output.innerHTML += `<p>Action magnitude: ${magnitude.toFixed(4)}</p>`;
                
                if (magnitude < 1e-6) {
                    output.innerHTML += `<p>❌ ERROR: Action magnitude too small - predator won't move!</p>`;
                } else {
                    output.innerHTML += `<p>✅ Action magnitude appears reasonable</p>`;
                }
                
                // Test multiple random inputs
                output.innerHTML += `<h2>Testing Multiple Random Inputs:</h2>`;
                for (let i = 0; i < 5; i++) {
                    const randomBoids = [];
                    for (let j = 0; j < 3; j++) {
                        randomBoids.push({
                            position: {x: Math.random() * 800, y: Math.random() * 600},
                            velocity: {x: (Math.random() - 0.5) * 4, y: (Math.random() - 0.5) * 4}
                        });
                    }
                    
                    const randomPredatorPos = {x: Math.random() * 800, y: Math.random() * 600};
                    const randomPredatorVel = {x: (Math.random() - 0.5) * 4, y: (Math.random() - 0.5) * 4};
                    
                    const randomInputs = inputProcessor.processInputs(
                        randomBoids, randomPredatorPos, randomPredatorVel, canvasWidth, canvasHeight
                    );
                    
                    const randomOutputs = transformer.forward(randomInputs);
                    const randomActions = actionProcessor.processAction(randomOutputs);
                    const randomMagnitude = Math.sqrt(randomActions[0] * randomActions[0] + randomActions[1] * randomActions[1]);
                    
                    output.innerHTML += `<p>Test ${i+1}: outputs=[${randomOutputs[0].toFixed(4)}, ${randomOutputs[1].toFixed(4)}], magnitude=${randomMagnitude.toFixed(4)}</p>`;
                }
                
            } catch (error) {
                output.innerHTML += `<p>❌ ERROR: ${error.message}</p>`;
                output.innerHTML += `<p>Stack: ${error.stack}</p>`;
            }
        }
        
        // Run debug when page loads
        document.addEventListener('DOMContentLoaded', debugTransformer);
    </script>
</body>
</html> 